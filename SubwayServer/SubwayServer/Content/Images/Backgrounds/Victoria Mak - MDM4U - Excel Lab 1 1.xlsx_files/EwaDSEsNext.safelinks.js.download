'use strict';(window.dullscriptWebpackJsonp=window.dullscriptWebpackJsonp||[]).push([[64],{1443:function(n,C,a){a.r(C);var c=a(9);n=a(0);var b=a(4);C=a(222);var d=a(15),f=a(84);class e{constructor(H,R,Q,O,V,W){this.PolicyCookie=this.WebAffinitizedUrl=this.IsSafeLinksEnabled=null;this.PolicyCookieTTL=0;this.WasServiceDown=!1;this.AffinitizedUrl=null;this.IsSafeLinksEnabled=H;this.WebAffinitizedUrl=R;this.PolicyCookie=Q;this.PolicyCookieTTL=O;this.WasServiceDown=V;this.AffinitizedUrl=W}}Object(n.a)(e,
"SafeLinksData",null,[]);class k{constructor(H,R){this.gAc=H;this.stopwatch=R}}Object(n.a)(k,"SafeLinksGetUrlReputationRequestData",null,[]);var l=a(41),m=a(39);class u{constructor(H,R,Q,O){this.nb=H;this.zh=R;this.Yqg=Q;u.Ch=O}Doa(H,R,Q){try{var O=null;u.Ch&&(O=u.Ch.Bc("WebServiceCall","SafeLinksGetUrlReputation"));const V=new k(R,O);O={};O.AffinitizedUrl=H;O.TargetUrl=R;O.PolicyCookie=Q;const W=l.c(O);this.zh.Jm(this.Yqg,2,W,null,!1,2,Object(f.a)(this,this.DMi,"onGetUrlReputationSuccessCallback"),
Object(f.a)(this,this.CMi,"onGetUrlReputationFailureCallback"),V,void 0,void 0,3E3,3E3,"36");return!0}catch(V){d.ULS.sendTraceTag(588788033,378,10,V.message)}return!1}DMi(H){let R="OnGetUrlReputationSuccessCallback: ",Q=10;const O=H.data.state;try{const V=l.b(H.data.Xd).reputationResults[0],W=V.navigateUrl.length,da=O.gAc.length,ta=V.navigateUrl===O.gAc;V.navigateUrl&&0<V.navigateUrl.length&&(O.gAc=V.navigateUrl);R+=String.format("HttpStatus {0}, verdict {1}, clickedUrlLength = {2} navigateUrlLength {3}, navigateUrlSameAsClickedUrl {4}",
H.data.httpStatus,V.verdict,da.toString(),W.toString(),ta.toString());Q=50}catch(V){R+=String.format("Exception {0}",V.message)}this.N6e(O,R,Q)}CMi(H){let R="OnGetUrlReputationFailureCallback: ";const Q=H.data.state;try{R+=String.format("HttpStatus {0}",H.data.httpStatus)}catch(O){R+=String.format("Exception {0}",O.message)}this.N6e(Q,R,10)}N6e(H,R,Q){H.stopwatch&&(H.stopwatch.stop(),H.stopwatch=null);d.ULS.sendTraceTag(588788034,378,Q,R);m.a.Ze(H.gAc,void 0,"noopener,noreferrer","SafeLinksNav")}}
u.Ch=null;Object(n.a)(u,"SafeLinksNavigationHelper",null,[]);var t;(function(H){H[H.enabledByPolicy=0]="enabledByPolicy";H[H.disabledByPolicy=1]="disabledByPolicy";H[H.disabled_GetPolicyFailure=2]="disabled_GetPolicyFailure";H[H.disabled_PendingGetPolicyRequest=3]="disabled_PendingGetPolicyRequest"})(t||(t={}));Object(n.b)("SafeLinksNavigationState",t);var w=a(98),r=a(135),v=a(816),y=a(251),x=a(238),B=a(687),z=a(27),A=a(173),I=a(188);class F{constructor(H,R,Q,O=!1,V=null,W=null){this.NDa=this.MDa=
0;this.Izb=this.rTb=!1;this.Yqa=null;this.OWa=!0;this.KWb=null;d.ULS.sendTraceTag(26019598,378,100,"Initializing SafeLinksManager.");this.nb=H;this.zh=R;this.fRb=Q;F.Ch=W;this.Zzg=O?this.nb.Xa("SafeLinksHandlerWebServiceBase"):this.nb.Xa("WebServiceBase");this.Hzg=this.nb.Xa("SafeLinksHashedUserId");this.cYj=this.nb.Xa("SafeLinksWorkloadIdHeaderValue");this.LUb=this.nb.qd("SafeLinksMaxGetPolicyBootRetries",2);this.MUb=this.nb.qd("SafeLinksMaxGetPolicyOnLinkClickRetries",1);this.VTb=this.isSafeLinksEnabledForUser();
this.UTb=this.vmi();d.ULS.sendTraceTag(26019599,378,50,"SafeLinksManager _isEnabledForUser={0}, _isEnabledForBrowser={1}",this.VTb,this.UTb);if(this.VTb&&this.UTb){R=(H=this.Z3a())?H.IsSafeLinksEnabled.toLowerCase():"";Q=this.pqd();d.ULS.sendTraceTag(36231312,378,50,"Cached values for IsSafeLinksEnabled: {0}, IsPolicyCookieExpired: {1}.",R,Q);var da=!H||"unknown"===R||H.WasServiceDown||Q,ta=r.a.Ur();ta&&(ta.set("shouldGetSafeLinksDataFromServer",da.toString()),ta.set("isSafeLinksEnabledCacheValue",
R.toString()));this.nb.getBooleanFeatureGate("Microsoft.Office.SharedOnline.SafeLinksLicenseCheck",!1)&&V?(this.OWa=!1,V.execute(K=>{K.isFeatureEnabled("MsoUrlreputation",!0).then(na=>{this.OWa=na;ta.set("isUserLicensedForSafeLinks",this.OWa.toString());w.Health.instance.recordKpiUsage("SafeLinksGetPolicy1",0,"jpittsdirects",ta);this.OWa&&da&&this.fcc(!0);return null})})):(w.Health.instance.recordKpiUsage("SafeLinksGetPolicy1",0,"jpittsdirects",ta),da&&this.fcc(!0))}}get appName(){return this.fRb}get MDc(){return this.Zzg}get userId(){return this.Hzg}get NUh(){const H=
this.MDc?this.MDc+"/":"",R=new y.QueryStringBuilder("SafeLinksHandler.ashx");R.Zi("app",this.appName);this.nb.qa("SafeLinksUseDebugHeader")&&R.Zi("action","debug");this.nb.getBooleanFeatureGate("Microsoft.Office.SharedOnline.SafeLinksS2SAuthAATPOP",!1)&&R.Zi("s2satpop","1");this.nb.getBooleanFeatureGate("Microsoft.Office.SharedOnline.SafeLinksS2SAuthAAT",!1)&&R.Zi("s2saat","1");this.nb.getBooleanFeatureGate("Microsoft.Office.SharedOnline.SafeLinksS2SAuthUseE03App",!1)&&R.Zi("s2se03","1");return String.format("{0}{1}&{2}",
H,R.toString(),b.AFrameworkApplication.qj)}get C_h(){const H=this.MDc?this.MDc+"/":"",R=new y.QueryStringBuilder("SafeLinksHandler.ashx");R.Zi("app",this.appName);this.nb.qa("SafeLinksUseDebugHeader")&&R.Zi("action","debug");this.nb.getBooleanFeatureGate("Microsoft.Office.SharedOnline.SafeLinksS2SAuthAATPOP",!1)&&R.Zi("s2satpop","1");this.nb.getBooleanFeatureGate("Microsoft.Office.SharedOnline.SafeLinksS2SAuthAAT",!1)&&R.Zi("s2saat","1");this.nb.getBooleanFeatureGate("Microsoft.Office.SharedOnline.SafeLinksS2SAuthUseE03App",
!1)&&R.Zi("s2se03","1");R.Zi("slrt","GetUrlReputation");return String.format("{0}{1}&{2}",H,R.toString(),b.AFrameworkApplication.qj)}get YCi(){F.GQc||(F.GQc=new u(this.nb,this.zh,this.C_h,F.Ch));return F.GQc}Doa(H){if(!H)return d.ULS.sendTraceTag(593367827,378,10,"SafeLinksManager.TryNavigate: Null/Empty targetUrl"),!1;var R=this.Wii(H);d.ULS.sendTraceTag(594830615,378,50,"SafeLinksManager.TryNavigate: isSupportedHyperLinkType={0},_isEnabledForUser={1},_isEnabledForBrowser={2},_isUserLicensedForSafeLinks={3}",
R,this.VTb,this.UTb,this.OWa);if(!(R&&this.VTb&&this.UTb&&this.OWa))return!1;R=0;const Q=({state:R}=this.Pyj()).returnValue;d.ULS.sendTraceTag(595079385,378,50,"ShouldTryUsingSafeLinksService returned NavigationState={0}",t[R]);const O=r.a.Ur();O&&O.set("SafeLinksNavigationState",t[R]);w.Health.instance.recordKpiUsage("SafeLinksNavigations",0,"jpittsdirects",O);if(!Q)return 2!==R&&3!==R||w.Health.instance.recordKpiFailure("SafeLinksNavigations",t[R],!1,!0,null),!1;d.ULS.sendTraceTag(26019601,378,
50,"Using safelinks to navigate hyperlink");if(this.Xyj())return this.pqd()?!1:this.YCi.Doa(this.tIh(),H,this.i2e());if(!this.pqd())return this.Xbg(H),!0;this.Yqa=H;d.ULS.sendTraceTag(24462627,378,50,"Refreshing the cache as policy cookie expired.");this.Izb=!1;this.fcc();return!0}Wii(H){H=H.toLowerCase();const R=this.nb.ow("SafeLinksUnsupportedProtocols");if(R)for(let Q=0;Q<R.length;Q++)if(H.startsWith(R[Q]))return!1;return!0}fcc(H=!1){var R=r.a.Ur();R&&R.set("isOnBootRequest",H.toString());w.Health.instance.recordKpiUsage("SafeLinksGetPolicySuccessfulRequest",
1,"jpittsdirects",R);w.Health.instance.recordKpiUsage("SafeLinksGetPolicyFailedRequest",0,"jpittsdirects",R);R=this.K3c("SafeLinksGetPolicy");this.zh.Jm(this.NUh,1,null,null,!0,2,Object(f.a)(this,this.dXh,"getSafeLinksDataFromServer_OnSuccessCallback"),Object(f.a)(this,this.cXh,"getSafeLinksDataFromServer_OnFailureCallback"),R,void 0,void 0,void 0,void 0,"23");this.Izb=H;this.rTb=!0;H?this.MDa++:this.NDa++}dXh(H){let R=x.a.XDi,Q="";try{this.rTb=this.Izb=!1;var O=H.data.state;const pa=({stopwatch:O}=
this.tzc(O)).returnValue,Na=Object.assign(new I.a,{durationMs:pa});w.Health.instance.recordKpiSuccess("SafeLinksGetPolicySuccessfulRequest",Na);d.ULS.sendTraceTag(594830614,378,50,"GetSafeLinksDataFromServer_OnSuccessCallback: HttpStatus {0}, data length {1}, Duration {2}",H.data.httpStatus,H.data.Xd.length,pa);if(H.data.httpStatus!==x.a.VO)Q="Unexpected httpStatus: "+H.data.httpStatus.toString();else{O=null;try{O=l.b(H.data.Xd)}catch(Z){Q="Exception:"+Z.toString()+" deserializing response";return}if(O){var V=
O.IsSafeLinksEnabled;if(void 0===V||null===V||0>=V.length)Q="Invalid isSafeLinksEnabledString";else{d.ULS.sendTraceTag(594830613,378,50,"Retrieved isSafeLinksEnabledString {0}",V);var W=F.ZDd(V);if(void 0===O.WebAffinitizedUrl||null===O.WebAffinitizedUrl||0>=O.WebAffinitizedUrl.length)Q="Invalid WebAffinitizedUrl";else if(void 0===O.PolicyCookie||null===O.PolicyCookie||0>=O.PolicyCookie.length)Q="Invalid PolicyCookie";else if(void 0===O.PolicyCookieTTL||null===O.PolicyCookieTTL)Q="Invalid PolicyCookieTTL";
else{var da=O.WebAffinitizedUrl,ta=O.PolicyCookie,K=O.AffinitizedUrl,na=new Date;na.setMinutes(na.getMinutes()+(5<O.PolicyCookieTTL?O.PolicyCookieTTL-5:0));var P=na.getTime(),ka=new e(V,da,ta,P,!1,K);this.ZZf(ka);R=H.data.httpStatus;this.Yqa&&(W?(this.Xbg(this.Yqa),this.NDa=this.MDa=0):(d.ULS.sendTraceTag(26019602,378,50,"SafeLinks is disabled by admin; Navigating without SafeLinks"),w.Health.instance.recordKpiFailure("SafeLinksNavigations","disabledByPolicy",!0,!0,null),m.a.LU(this.Yqa)),this.Yqa=
null)}}}else Q="Error when serializing response into SafeLinksData. SafeLinksData is null."}}catch(pa){Q="GetSafeLinksDataFromServer_OnSuccessCallback: Exception:  "+pa.toString()}finally{R!==x.a.VO&&this.M6e(R,Q)}}cXh(H){this.rTb=!1;let R=500,Q="";try{let O=H.data.state;const V=({stopwatch:O}=this.tzc(O)).returnValue,W=Object.assign(new I.a,{durationMs:V});R=H.data.httpStatus;w.Health.instance.recordKpiFailure("SafeLinksGetPolicyFailedRequest","HttpStatusCode_"+R.toString(),!1,!0,W);Q="Request Failed, Status="+
B.a[H.data.status]+" Duration: "+V}catch(O){Q="GetSafeLinksDataFromServer_OnFailureCallback Exception: "+O.toString()}finally{this.M6e(R,Q)}}M6e(H,R=""){try{if(d.ULS.sendTraceTag(594830612,378,10,"HandleGetPolicyRequestError: HttpStatus {0}, Error {1}",H,R),this.MDa<this.LUb&&this.NDa<this.MUb)this.fcc(this.Izb);else{this.Izb=!1;d.ULS.sendTraceTag(24462656,378,10,"Exhausted all retries for SafeLinks GetPolicy call. OnBootRetries: {0}, OnClickRetries: {1}, HttpStatus: {2}, Error: {3}",this.MDa,this.NDa,
H,R);R=null;const Q=r.a.Ur();Q&&(Q.set("HttpStatus",H.toString()),R=Object.assign(new I.a,{extendedProperties:Q}));w.Health.instance.recordKpiFailure("SafeLinksGetPolicy1","GetPolicyRequestError",!1,!0,R);const O=new e("false","","",0,!0,"");this.ZZf(O);this.Yqa&&(d.ULS.sendTraceTag(26019603,378,50,"Error occurred during at-click GetPolicy call, NavigationState = {0}","disabled_GetPolicyFailure"),w.Health.instance.recordKpiFailure("SafeLinksNavigations","disabled_GetPolicyFailure",!1,!0,null),m.a.LU(this.Yqa),
this.Yqa=null)}}catch(Q){d.ULS.sendTraceTag(594830611,378,10,"HandleGetPolicyRequestError: Exception {0}",Q.toString())}}Xbg(H){const R=this.i2e(),Q=this.o0h(),O={};O.Url=H;O.SafeLinksCookie=R;O.CorrelationId=A.a.create().toString();O.WorkloadId=this.cYj;O.UserAgentInfo=z.a.PGa+"|"+this.appName;d.ULS.sendTraceTag(23900187,378,50,"Validating hyperlink with request correlation: {0}",O.CorrelationId);m.a.Eqc(m.a.cX(4),Q,O)}isSafeLinksEnabledForUser(){const H=this.nb.Xa("IsSafeLinksEnabledForUser");return H?
F.ZDd(H):!1}vmi(){const H=this.nb.ow("SafeLinksDisabledBrowsers");if(z.a.xz){if(this.nb.wo("SafeLinksForTeamsIsEnabled")&&this.nb.qa("SafeLinksForTeamsIsEnabled"))return!0;if(Array.contains(H,"Electron"))return!1}else if(Array.contains(H,z.a.PGa))return!1;return"officecomhwa"===(this.nb.Xa(b.AFrameworkApplication.R7)||"").toLowerCase()?!1:!0}Xyj(){return-1!==window.location.href.indexOf("&wd_slnh=1")||this.nb.getBooleanFeatureGate("Microsoft.Office.SharedOnline.SafeLinksUseNavigationHelperForMobile",
!1)&&z.a.Y4?!0:z.a.xz}Pyj(){let H;H=0;const R=this.Z3a(),Q=R?R.IsSafeLinksEnabled:"";if(""!==Q)return R.WasServiceDown?(d.ULS.sendTraceTag(51663971,378,50,"Failed to retrieve policy data"),{returnValue:!1,state:2}):"false"===Q.toLowerCase()?(d.ULS.sendTraceTag(51664E3,378,50,"SafeLinks disabled for the user"),{returnValue:!1,state:1}):{returnValue:F.ZDd(Q),state:H};if(this.rTb)return H=3,d.ULS.sendTraceTag(595079384,378,50,"Currently getting SafeLinks policy"),{returnValue:!1,state:H};if(this.MDa>=
this.LUb||this.NDa>=this.MUb)return H=2,d.ULS.sendTraceTag(51664001,378,50,"Exhausted all retries- Failure in GetPolicy for SafeLinks ({0}/{1} boot, {2}/{3} onClick)",this.MDa,this.LUb,this.NDa,this.MUb),{returnValue:!1,state:H};d.ULS.sendTraceTag(23900182,378,10,"Inconsistent SafeLinks state: SafeLinks cache data is null with no on boot request pending, and {0} retries left over. Perhaps LocalStorage is inaccessable.",this.LUb+this.MUb-(this.MDa+this.NDa));return{returnValue:!0,state:H}}i2e(){const H=
this.Z3a();return H?H.PolicyCookie:""}o0h(){const H=this.Z3a();return H?H.WebAffinitizedUrl:""}tIh(){const H=this.Z3a();return H?H.AffinitizedUrl:""}zOh(){const H=new Date;try{const R=this.Z3a();H.setTime(R?R.PolicyCookieTTL:0)}catch(R){d.ULS.sendTraceTag(24462658,378,10,"Exception occured while fetching expiration time from cache: {0}",R)}return H}pqd(){const H=this.zOh();return!!H&&H.getTime()<Date.now()}Z3a(){if(!this.KWb){const H=v.a.instance.getItem(this.userId);if(!H||""===H)return null;this.KWb=
JSON.parse(H)}return this.KWb}ZZf(H){if(void 0===H||null===H)throw Error.argumentNull("safeLinksData");if(void 0===H.IsSafeLinksEnabled||null===H.IsSafeLinksEnabled||0>=H.IsSafeLinksEnabled.length)throw Error.argumentNull("safeLinksData.IsSafeLinksEnabled");this.KWb=H;H.WasServiceDown||this.kYj(H)}kYj(H){H=JSON.stringify(H);v.a.instance.setItem(this.userId,H)}K3c(H){return void 0!==F.Ch&&null!==F.Ch?F.Ch.Bc("WebServiceCall",H):null}tzc(H){if(void 0!==H&&null!==H){const R=H.yc;H.stop();return{returnValue:R,
stopwatch:null}}return{returnValue:null,stopwatch:H}}static ZDd(H){return"false"!==H.toLowerCase()?!0:!1}}F.Ch=null;F.GQc=null;Object(n.a)(F,"SafeLinksManager",null,[514]);const U=H=>{switch(H){case 3:return"Word";case 2:return"PowerPoint";case 1:return"Excel";default:return"Unknown"}},X=H=>{switch(H){case 1:return"Edit";case 2:return"View";case 3:return"InstantView";default:return"Unknown"}};var T=a(699);class G extends C.a{constructor(H){super();this.$=H;this.Eb()}create(){const H=Object(T.a)(this.$.da,
269,()=>new F(b.AFrameworkApplication.fa,b.AFrameworkApplication.yd,`${U(b.AFrameworkApplication.ta.Oa.Dj)}-${X(b.AFrameworkApplication.ta.Oa.a6)}`));this.pb(H)}static ka(H){H.da.Ga(270,new G(H))}}Object(n.a)(G,"SafeLinksManagerFactory",C.a,[]);var D=a(1),J=a(255),L=a(218);Type.registerNamespace("_Ewa");Type.registerNamespace("Common.App.SafeLinks");(()=>{D.EwaSettings.Vpd()?Object(L.b)(J.b,{gCb:"singleton"})(()=>new F(b.AFrameworkApplication.fa,b.AFrameworkApplication.yd,String.format("{0}-{1}",
U(b.AFrameworkApplication.ta.Oa.Dj),X(b.AFrameworkApplication.ta.Oa.a6)))):c.a.Fa(H=>{G.ka(H)})})()}}]);

//# sourceMappingURL=https://artifacts.dev.azure.com/office/_apis/symbol/symsrv/EwaDSEsNext.safelinks.js.map/55f1815e849cac599164d8cf36b14e4e/EwaDSEsNext.safelinks.js.map